<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spotify Playlist Portrait</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap"
        rel="stylesheet" />

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: #212529;
        }

        .title-font {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
        }

        #threeContainer {
            width: 100%;
            height: 100%;
            background-color: #000000;
            border-radius: 0.75rem;
            overflow: hidden;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #212529;
            border-radius: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .loader {
            border: 3px solid rgba(0, 0, 0, 0.05);
            border-left-color: #212529;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .btn-primary {
            background-color: #212529;
            color: white;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background-color: #343a40;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #e9ecef;
            color: #212529;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background-color: #dee2e6;
        }

        .btn-active {
            background-color: #212529;
            color: white;
        }

        .card {
            background-color: white;
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        }

        .gradient-text {
            background: linear-gradient(90deg, #212529, #495057);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>

<body>
    <div class="min-h-screen bg-gradient-to-b from-white to-gray-50">
        <div id="initialView" class="p-4 md:p-8">
            <div class="max-w-7xl mx-auto">
                <header class="text-center mb-12 mt-8">
                    <h1 class="title-font text-5xl sm:text-6xl gradient-text mb-6">Playlist Portrait</h1>
                    <p class="text-gray-600 max-w-2xl mx-auto text-lg">
                        Visualize the sonic landscape of your Spotify playlists through data-driven aesthetics
                    </p>
                </header>

                <div class="max-w-3xl mx-auto mb-16">
                    <div class="card p-6 sm:p-8">
                        <input type="text" id="playlistUrl"
                            class="w-full border-0 border-b-2 border-gray-200 p-3 sm:p-4 mb-6 text-base sm:text-lg focus:outline-none focus:border-gray-900 transition bg-transparent"
                            placeholder="Paste your Spotify playlist URL" />
                        <button id="analyzeBtn"
                            class="w-full btn-primary rounded-lg py-4 text-base sm:text-lg font-medium shadow-sm">
                            Analyze & Visualize
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="resultsContainer" class="hidden h-screen flex flex-col">
            <header class="bg-white shadow-sm py-3 px-6 sticky top-0 z-10">
                <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center">
                    <div class="flex items-center mb-3 md:mb-0">
                        <h1 class="title-font text-2xl gradient-text mr-4">Playlist Portrait</h1>
                        <div id="playlistInfo" class="text-gray-600 text-sm md:text-base truncate max-w-md">
                            <span id="playlistUrlDisplay" class="font-medium"></span>
                        </div>
                    </div>
                    <button id="backBtn" class="btn-secondary px-4 py-2 rounded-md text-sm shadow-sm">
                        Analyze Another Playlist
                    </button>
                </div>
            </header>

            <div class="flex-grow overflow-hidden">
                <div class="h-full grid grid-cols-1 lg:grid-cols-9 gap-6 p-4 md:p-6">
                    <div class="lg:col-span-4 flex flex-col max-h-[calc(100vh-120px)]">
                        <div class="card p-6 flex flex-col h-full overflow-hidden">
                            <h2 class="text-xl font-medium mb-4 text-gray-900">Analysis</h2>
                            <div id="loadingAnalysis" class="hidden flex-grow flex items-center justify-center">
                                <div class="loader"></div>
                            </div>
                            <div id="analysisText" class="text-gray-700 overflow-y-auto custom-scrollbar flex-grow leading-relaxed"></div>
                            <div class="mt-4 text-sm text-gray-500">
                                <span id="trackCount" class="font-medium"></span>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-5 flex flex-col max-h-[calc(100vh-120px)]">
                        <div class="card p-6 flex flex-col h-full relative">
                            <div class="flex flex-col h-full">
                                <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                                    <h2 id="visualizationTitle" class="text-xl font-medium">
                                        Energy Visualization
                                    </h2>
                                    <div class="flex flex-wrap gap-2">
                                        <button id="energyBtn"
                                            class="btn-active px-4 py-2 rounded-md text-sm shadow-sm transition-colors">
                                            Energy
                                        </button>
                                        <button id="danceBtn"
                                            class="btn-secondary px-4 py-2 rounded-md text-sm shadow-sm transition-colors">
                                            Danceability
                                        </button>
                                        <button id="moodBtn"
                                            class="btn-secondary px-4 py-2 rounded-md text-sm shadow-sm transition-colors">
                                            Mood
                                        </button>
                                    </div>
                                </div>

                                <div style="height: calc(100vh - 280px);" class="relative">
                                    <div id="threeContainer" class="absolute inset-0 rounded-lg"></div>
                                </div>

                                <div class="mt-4 pt-2">
                                    <div id="dataSourceIndicator" class="mb-2 text-xs text-gray-500 hidden text-center">
                                        Data source: <span id="dataSource" class="font-medium">AI Prediction</span>
                                    </div>

                                    <div id="colorLegendContainer" class="flex flex-col items-center">
                                        <div id="energyLegend" class="hidden flex items-center justify-center space-x-3">
                                            <span class="text-xs text-gray-600">Low Energy</span>
                                            <div
                                                class="w-40 h-3 bg-gradient-to-r from-blue-500 via-purple-500 to-red-500 rounded-full">
                                            </div>
                                            <span class="text-xs text-gray-600">High Energy</span>
                                        </div>

                                        <div id="danceabilityLegend"
                                            class="hidden flex items-center justify-center space-x-3">
                                            <span class="text-xs text-gray-600">Less Danceable</span>
                                            <div
                                                class="w-40 h-3 bg-gradient-to-r from-purple-600 via-indigo-500 to-green-500 rounded-full">
                                            </div>
                                            <span class="text-xs text-gray-600">More Danceable</span>
                                        </div>

                                        <div id="moodLegend" class="hidden flex items-center justify-center space-x-3">
                                            <span class="text-xs text-gray-600">Negative</span>
                                            <div
                                                class="w-40 h-3 bg-gradient-to-r from-red-500 via-orange-400 to-green-400 rounded-full">
                                            </div>
                                            <span class="text-xs text-gray-600">Positive</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="songTooltip"
                                class="hidden absolute bg-black bg-opacity-90 text-white px-4 py-3 rounded-lg text-sm pointer-events-none z-10 shadow-xl">
                                <div id="tooltipTitle" class="font-bold"></div>
                                <div id="tooltipArtist" class="text-xs text-gray-300"></div>
                                <div id="tooltipValue" class="text-xs mt-2 font-medium"></div>
                            </div>

                            <div id="loadingVisualization" class="hidden absolute inset-0 flex items-center justify-center
                            bg-white bg-opacity-90 rounded-xl">
                                <div class="loader"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        const state = {
            isLoading: false,
            playlistData: null,
            visualizationMode: 'energy'
        };

        const elements = {
            playlistUrlInput: document.getElementById('playlistUrl'),
            analyzeBtn: document.getElementById('analyzeBtn'),
            backBtn: document.getElementById('backBtn'),
            initialView: document.getElementById('initialView'),
            resultsContainer: document.getElementById('resultsContainer'),
            analysisText: document.getElementById('analysisText'),
            trackCount: document.getElementById('trackCount'),
            loadingAnalysis: document.getElementById('loadingAnalysis'),
            loadingVisualization: document.getElementById('loadingVisualization'),
            threeContainer: document.getElementById('threeContainer'),
            songTooltip: document.getElementById('songTooltip'),
            tooltipTitle: document.getElementById('tooltipTitle'),
            tooltipArtist: document.getElementById('tooltipArtist'),
            tooltipValue: document.getElementById('tooltipValue'),
            playlistUrlDisplay: document.getElementById('playlistUrlDisplay')
        };

        elements.analyzeBtn.addEventListener('click', handleAnalyzeButtonClick);
        elements.backBtn.addEventListener('click', () => {
            elements.resultsContainer.classList.add('hidden');
            elements.initialView.classList.remove('hidden');
        });

        document.getElementById('energyBtn').addEventListener('click', () => {
            switchVisualizationMode('energy');
        });
        document.getElementById('danceBtn').addEventListener('click', () => {
            switchVisualizationMode('danceability');
        });
        document.getElementById('moodBtn').addEventListener('click', () => {
            switchVisualizationMode('mood');
        });

        async function fetchPlaylistAnalysis(playlistUrl) {
            try {
                const response = await fetch('https://spotify-analyzer-4o.vercel.app/api/analyze-playlist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        playlist_url: playlistUrl
                    })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();
                if (data.detail) {
                    throw new Error(data.detail);
                }

                if (!data.songs || data.songs.length === 0) {
                    data.songs = generateSongDataWithAttributes(data.track_count || 20);
                }

                return data;
            } catch (error) {
                console.error('API error:', error);
                throw error;
            }
        }

        function generateSampleAnalysisData() {
            const songs = generateSongDataWithAttributes(25);
            
            return {
                playlist_analysis: `This playlist weaves a rich tapestry of emotions and cultural influences, guiding the listener through an experience that is both introspective and globally inspired. The journey begins with "${songs[0].title}" by ${songs[0].artist}, a track that sets a contemplative tone, steeping the listener in dreamy introspection. This vibe is stretched and warmed by "${songs[1].title}" by ${songs[1].artist}, whose instrumental depth evokes vivid imagery of serene landscapes.

As we progress into "${songs[2].title}" by ${songs[2].artist}, there is a transition into more abstract sonic territories, blending indie with electronic tinges, an invitation to explore the multifaceted nature of modern soundscapes. The energy shifts with "${songs[3].title}" by ${songs[3].artist}, which injects raw, live energy into the mix, creating a powerful contrast with the earlier atmospheric pieces.

The playlist's middle section, anchored by tracks like "${songs[Math.floor(songs.length/2)].title}", explores themes of personal reflection and emotional resonance. The production values here showcase a masterful balance between electronic and organic elements, creating a sonic bridge between traditional and contemporary approaches.

The latter portion of the playlist demonstrates remarkable curatorial vision, with "${songs[songs.length-2].title}" and "${songs[songs.length-1].title}" bringing the journey full circle. These closing tracks maintain the emotional depth established earlier while introducing elements of hope and resolution, creating a satisfying conclusion to this carefully crafted musical journey.

Throughout the playlist, the energy levels ebb and flow naturally, creating distinct moments of both introspection and elevation. The danceability factor varies intentionally, with some tracks featuring strong rhythmic elements while others favor melodic complexity. This thoughtful arrangement creates a dynamic listening experience that rewards both casual and focused listening sessions.`,
                track_count: songs.length,
                songs: songs
            };
        }

        function generateSongDataWithAttributes(trackCount) {
            const songs = [];
            const trackNames = [
                'Midnight Reverie', 'Solar Echoes', 'Crystal Fragments', 
                'Urban Dreams', 'Velvet Morning', 'Neon Cascade', 
                'Ambient Flight', 'Cosmic Drift', 'Azure Waves',
                'Lunar Phase', 'Electric Soul', 'Golden Hour',
                'Metro Pulse', 'Stellar Wind', 'Ocean Mind'
            ];
            
            const artistNames = [
                'The Midnight Collective', 'Ethereal Soundscape', 'Sonic Architects', 
                'Urban Dreamers', 'Velvet Horizon', 'Neon Symphony', 
                'Ambient Explorers', 'Cosmic Drifters', 'Azure Ensemble',
                'Lunar Theory', 'Electric Souls', 'Golden Harmonics'
            ];

            for (let i = 0; i < trackCount; i++) {
                const trackIndex = i % trackNames.length;
                const artistIndex = i % artistNames.length;
                
                const trackName = `${trackNames[trackIndex]}`;
                const artistName = artistNames[artistIndex];

                const baseEnergy = Math.sin((i / trackCount) * Math.PI * 2) * 0.4 + 
                                  Math.cos((i / trackCount) * Math.PI * 3) * 0.2 + 0.5;
                
                const baseDance = Math.cos((i / trackCount) * Math.PI * 2.5) * 0.3 + 
                                 Math.sin((i / trackCount) * Math.PI * 1.5) * 0.3 + 0.5;
                
                const baseMood = Math.sin((i / trackCount) * Math.PI * 1.8) * 0.35 + 
                                Math.cos((i / trackCount) * Math.PI * 2.2) * 0.25 + 0.5;

                const noise = Math.random() * 0.2 - 0.1;
                
                const energy = Math.max(0.1, Math.min(0.95, baseEnergy + noise));
                const danceability = Math.max(0.1, Math.min(0.95, baseDance + noise));
                const mood = Math.max(0.1, Math.min(0.95, baseMood + noise));

                songs.push({
                    title: trackName,
                    artist: artistName,
                    energy: energy,
                    danceability: danceability,
                    mood: mood,
                    tempo: 70 + Math.floor(Math.random() * 110)
                });
            }

            return songs;
        }

        function displayAnalysisResults(data) {
            elements.analysisText.innerHTML = `<p>${data.playlist_analysis.replace(/\n/g, '<br>')}</p>`;
            elements.trackCount.textContent = data.track_count ? `${data.track_count} tracks analyzed` : '';
            document.getElementById('dataSourceIndicator').classList.remove('hidden');
            document.getElementById('dataSource').textContent = data.songs && data.songs[0].source === 'api' ? 'Spotify API' : 'AI Prediction';
        }

        function switchVisualizationMode(mode) {
            state.visualizationMode = mode;

            const energyBtn = document.getElementById('energyBtn');
            const danceBtn = document.getElementById('danceBtn');
            const moodBtn = document.getElementById('moodBtn');
            const visualizationTitle = document.getElementById('visualizationTitle');

            [energyBtn, danceBtn, moodBtn].forEach(btn => {
                btn.classList.remove('btn-active');
                btn.classList.add('btn-secondary');
            });

            document.getElementById('energyLegend').classList.add('hidden');
            document.getElementById('danceabilityLegend').classList.add('hidden');
            document.getElementById('moodLegend').classList.add('hidden');

            switch (mode) {
                case 'energy':
                    energyBtn.classList.remove('btn-secondary');
                    energyBtn.classList.add('btn-active');
                    visualizationTitle.textContent = 'Energy Visualization';
                    document.getElementById('energyLegend').classList.remove('hidden');
                    break;
                case 'danceability':
                    danceBtn.classList.remove('btn-secondary');
                    danceBtn.classList.add('btn-active');
                    visualizationTitle.textContent = 'Danceability Visualization';
                    document.getElementById('danceabilityLegend').classList.remove('hidden');
                    break;
                case 'mood':
                    moodBtn.classList.remove('btn-secondary');
                    moodBtn.classList.add('btn-active');
                    visualizationTitle.textContent = 'Mood Visualization';
                    document.getElementById('moodLegend').classList.remove('hidden');
                    break;
            }

            if (state.playlistData && window.visualizer) {
                window.visualizer.updateVisualization(state.playlistData, mode);
            }
        }

        class ModernPlaylistVisualizer {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.renderer = null;
                this.scene = null;
                this.camera = null;
                this.isInitialized = false;
                this.bars = [];
                this.songs = [];
                this.currentMode = 'energy';
                this.targetHeights = [];
                this.controls = null;

                this.animationStartTime = null;
                this.animationProgress = 0;
                this.animationDuration = 1200;
                this.animationComplete = false;
                this.isAnimating = false;

                this.raycaster = new THREE.Raycaster();
                this.mouse = new THREE.Vector2();
                this.hoveredBar = null;
                this.tooltip = document.getElementById('songTooltip');
                this.tooltipTitle = document.getElementById('tooltipTitle');
                this.tooltipArtist = document.getElementById('tooltipArtist');
                this.tooltipValue = document.getElementById('tooltipValue');

                this.animate = this.animate.bind(this);
                this.onMouseMove = this.onMouseMove.bind(this);
                this.handleResize = this.handleResize.bind(this);
                this.createBars = this.createBars.bind(this);
                this.updateVisualization = this.updateVisualization.bind(this);

                this.container.addEventListener('mousemove', this.onMouseMove);
                this.container.addEventListener('mouseleave', () => {
                    if (this.tooltip) {
                        this.tooltip.classList.add('hidden');
                    }
                    if (this.hoveredBar) {
                        this.hoveredBar.material.emissive.multiplyScalar(0.5);
                        this.hoveredBar = null;
                    }
                });

                window.addEventListener('resize', this.handleResize);
            }

            initialize() {
                if (this.isInitialized) return;

                const width = this.container.clientWidth;
                const height = this.container.clientHeight || 450;

                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x000000);

                this.camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
                this.camera.position.set(0, 35, 45);
                this.camera.lookAt(0, 5, 0);

                this.renderer = new THREE.WebGLRenderer({
                    antialias: true,
                    alpha: true
                });
                this.renderer.setSize(width, height);
                this.renderer.setPixelRatio(window.devicePixelRatio);

                while (this.container.firstChild) {
                    this.container.removeChild(this.container.firstChild);
                }
                this.container.appendChild(this.renderer.domElement);

                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                this.scene.add(ambientLight);

                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(5, 10, 7.5);
                this.scene.add(directionalLight);

                const backLight = new THREE.DirectionalLight(0xffffff, 0.4);
                backLight.position.set(-5, 5, -7.5);
                this.scene.add(backLight);

                this.isInitialized = true;
            }

            handleResize() {
                if (!this.isInitialized) return;

                const width = this.container.clientWidth;
                const height = this.container.clientHeight;

                this.camera.aspect = width / height;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(width, height);
            }

            loadSongs(songData, mode) {
                this.initialize();
                this.songs = this.normalizeFeatureValues(songData, mode);
                this.currentMode = mode;
                this.clearScene();
                this.createVisualization();
                this.startAnimation();
            }

            getFeatureName(mode) {
                switch (mode) {
                    case 'danceability':
                        return 'danceability';
                    case 'mood':
                        return 'mood';
                    default:
                        return 'energy';
                }
            }

            normalizeFeatureValues(songData, mode) {
                const featureName = this.getFeatureName(mode);
                if (!featureName) return songData;

                const values = songData.map(song => song[featureName]);
                const sortedValues = [...values].sort((a, b) => a - b);

                return songData.map(song => {
                    const value = song[featureName] || 0.5;
                    const index = sortedValues.indexOf(value);
                    const normalizedRank = index / Math.max(1, (sortedValues.length - 1));

                    return {
                        ...song,
                        normalizedValue: normalizedRank,
                        value: value
                    };
                });
            }

            updateVisualization(songData, mode) {
                this.currentMode = mode;
                this.songs = this.normalizeFeatureValues(songData, mode);
                this.clearScene();
                this.createVisualization();
                this.startAnimation();
            }

            clearScene() {
                for (let i = this.scene.children.length - 1; i >= 0; i--) {
                    const object = this.scene.children[i];
                    
                    if (object instanceof THREE.Light) continue;
                    
                    if (object.geometry) object.geometry.dispose();
                    if (object.material) {
                        if (Array.isArray(object.material)) {
                            object.material.forEach(mat => mat.dispose());
                        } else {
                            object.material.dispose();
                        }
                    }
                    this.scene.remove(object);
                }

                this.bars = [];
                this.targetHeights = [];
            }

            createVisualization() {
                if (!this.songs || this.songs.length === 0) return;

                this.createBars();

                const songCount = this.songs.length;
                
                const cameraZ = Math.max(45, songCount * 0.5);
                const cameraY = 35;
                
                this.camera.position.set(0, cameraY, cameraZ);
                this.camera.lookAt(0, 5, 0);
                
                this.camera.fov = Math.min(50, 40 + songCount * 0.1);
                this.camera.updateProjectionMatrix();
            }

            createBars() {
                const songCount = this.songs.length;
                if (songCount === 0) return;

                const maxBarWidth = 1.5;
                const minBarWidth = 0.5;
                const maxSpacing = 0.5;
                const minSpacing = 0.2;

                let barWidth, spacing;

                if (songCount <= 10) {
                    barWidth = maxBarWidth;
                    spacing = maxSpacing;
                } else if (songCount > 50) {
                    barWidth = minBarWidth;
                    spacing = minSpacing;
                } else {
                    const t = (songCount - 10) / 40;
                    barWidth = maxBarWidth - t * (maxBarWidth - minBarWidth);
                    spacing = maxSpacing - t * (maxSpacing - minSpacing);
                }

                const totalWidth = (barWidth + spacing) * songCount - spacing;
                const startX = -totalWidth / 2 + barWidth / 2;

                const planeWidth = Math.max(totalWidth * 1.5, 50);
                const planeGeometry = new THREE.PlaneGeometry(planeWidth, planeWidth);
                const planeMaterial = new THREE.MeshStandardMaterial({
                    color: 0x111111,
                    metalness: 0.7,
                    roughness: 0.5
                });
                const plane = new THREE.Mesh(planeGeometry, planeMaterial);
                plane.rotation.x = -Math.PI / 2;
                plane.position.y = 0;
                this.scene.add(plane);

                const gridHelper = new THREE.GridHelper(planeWidth, 20, 0x444444, 0x222222);
                gridHelper.position.y = 0.01;
                this.scene.add(gridHelper);

                const maxHeight = 12;
                const minHeight = 0.5;
                const heightRange = maxHeight - minHeight;
                
                this.bars = [];
                this.targetHeights = [];

                for (let i = 0; i < songCount; i++) {
                    const song = this.songs[i];
                    const value = song.normalizedValue !== undefined ? song.normalizedValue : 0.5;

                    const finalHeight = minHeight + (value * heightRange);
                    this.targetHeights.push(finalHeight);

                    const color = this.getColorForValue(value, this.currentMode);

                    const geometry = new THREE.BoxGeometry(barWidth, 0.01, barWidth);

                    const material = new THREE.MeshPhongMaterial({
                        color: color,
                        transparent: true,
                        opacity: 0.9,
                        shininess: 100,
                        emissive: color.clone().multiplyScalar(0.3),
                        specular: 0xffffff
                    });

                    const bar = new THREE.Mesh(geometry, material);

                    const xPos = startX + i * (barWidth + spacing);
                    bar.position.set(xPos, 0.005, 0);

                    bar.userData = {
                        songIndex: i,
                        title: song.title || 'Unknown',
                        artist: song.artist || 'Unknown Artist',
                        value: song[this.getFeatureName(this.currentMode)],
                        normalizedValue: value
                    };

                    this.scene.add(bar);
                    this.bars.push(bar);
                }
            }

            startAnimation() {
                this.animationStartTime = Date.now();
                this.animationProgress = 0;
                this.animationDuration = 1200;
                this.animationComplete = false;

                if (!this.isAnimating) {
                    this.isAnimating = true;
                    this.animate();
                }
            }

            animate() {
                if (!this.isInitialized) return;

                requestAnimationFrame(this.animate);

                if (!this.animationComplete && this.bars.length > 0 && this.targetHeights.length > 0) {
                    const currentTime = Date.now();
                    const elapsed = currentTime - this.animationStartTime;
                    this.animationProgress = Math.min(elapsed / this.animationDuration, 1.0);

                    const easedProgress = this.easeOutBack(this.animationProgress);

                    for (let i = 0; i < this.bars.length; i++) {
                        const bar = this.bars[i];
                        if (!bar || !bar.geometry) continue;

                        const targetHeight = this.targetHeights[i];
                        const currentHeight = targetHeight * easedProgress;

                        bar.geometry.dispose();
                        bar.geometry = new THREE.BoxGeometry(bar.geometry.parameters.width, currentHeight, bar.geometry.parameters.depth);
                        bar.position.y = currentHeight / 2;
                    }

                    if (this.animationProgress >= 1.0) {
                        this.animationComplete = true;
                    }
                }

                this.renderer.render(this.scene, this.camera);
            }

            easeOutBack(x) {
                const c1 = 1.70158;
                const c3 = c1 + 1;
                return 1 + c3 * Math.pow(x - 1, 3) + c1 * Math.pow(x - 1, 2);
            }

            onMouseMove(event) {
                if (!this.isInitialized || !this.tooltip) return;

                const rect = this.renderer.domElement.getBoundingClientRect();
                const x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                const y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

                this.mouse.set(x, y);
                this.raycaster.setFromCamera(this.mouse, this.camera);

                const intersects = this.raycaster.intersectObjects(this.bars);

                if (this.hoveredBar && (!intersects.length || intersects[0].object !== this.hoveredBar)) {
                    this.hoveredBar.material.emissive = this.hoveredBar.material.color.clone().multiplyScalar(0.3);
                    this.hoveredBar = null;
                }

                if (intersects.length > 0) {
                    const object = intersects[0].object;
                    const userData = object.userData;

                    if (this.hoveredBar !== object) {
                        if (this.hoveredBar) {
                            this.hoveredBar.material.emissive = this.hoveredBar.material.color.clone().multiplyScalar(0.3);
                        }
                        this.hoveredBar = object;
                        object.material.emissive = object.material.color.clone().multiplyScalar(0.8);
                    }

                    this.tooltipTitle.textContent = userData.title;
                    this.tooltipArtist.textContent = userData.artist;

                    let valueText;
                    switch (this.currentMode) {
                        case 'energy':
                            valueText = `Energy: ${(userData.value * 100).toFixed(1)}%`;
                            break;
                        case 'danceability':
                            valueText = `Danceability: ${(userData.value * 100).toFixed(1)}%`;
                            break;
                        case 'mood':
                            valueText = `Mood: ${(userData.value * 100).toFixed(1)}%`;
                            break;
                        default:
                            valueText = `Value: ${(userData.value * 100).toFixed(1)}%`;
                    }
                    this.tooltipValue.textContent = valueText;

                    this.tooltip.classList.remove('hidden');
                    this.tooltip.style.display = 'block';

                    const tooltipX = event.clientX + 10;
                    const tooltipY = event.clientY - 10;

                    const tooltipWidth = this.tooltip.offsetWidth;
                    const tooltipHeight = this.tooltip.offsetHeight;
                    const windowWidth = window.innerWidth;
                    const windowHeight = window.innerHeight;

                    let finalX = tooltipX;
                    let finalY = tooltipY;

                    if (tooltipX + tooltipWidth > windowWidth) {
                        finalX = event.clientX - tooltipWidth - 10;
                    }

                    if (tooltipY + tooltipHeight > windowHeight) {
                        finalY = event.clientY - tooltipHeight - 10;
                    }

                    this.tooltip.style.position = 'fixed';
                    this.tooltip.style.zIndex = '1000';
                    this.tooltip.style.left = `${finalX}px`;
                    this.tooltip.style.top = `${finalY}px`;
                } else {
                    this.tooltip.classList.add('hidden');
                    this.tooltip.style.display = 'none';
                }
            }

            getColorForValue(normalizedValue, mode) {
                if (mode === 'energy') {
                    if (normalizedValue < 0.33) {
                        const t = normalizedValue / 0.33;
                        return new THREE.Color(
                            0.1 + t * 0.2,
                            0.1 + t * 0.1,
                            0.7 - t * 0.2
                        );
                    } else if (normalizedValue < 0.66) {
                        const t = (normalizedValue - 0.33) / 0.33;
                        return new THREE.Color(
                            0.3 + t * 0.4,
                            0.2 - t * 0.1,
                            0.5 - t * 0.2
                        );
                    } else {
                        const t = (normalizedValue - 0.66) / 0.34;
                        return new THREE.Color(
                            0.7 + t * 0.3,
                            0.1 + t * 0.1,
                            0.3 - t * 0.2
                        );
                    }
                } else if (mode === 'mood') {
                    if (normalizedValue < 0.5) {
                        const t = normalizedValue / 0.5;
                        return new THREE.Color(
                            0.9,
                            0.1 + t * 0.4,
                            0.1
                        );
                    } else {
                        const t = (normalizedValue - 0.5) / 0.5;
                        return new THREE.Color(
                            0.9 - t * 0.6,
                            0.5 + t * 0.4,
                            0.1 + t * 0.1
                        );
                    }
                } else if (mode === 'danceability') {
                    if (normalizedValue < 0.4) {
                        const t = normalizedValue / 0.4;
                        return new THREE.Color(
                            0.5 - t * 0.3,
                            0.0 + t * 0.1,
                            0.6
                        );
                    } else if (normalizedValue < 0.7) {
                        const t = (normalizedValue - 0.4) / 0.3;
                        return new THREE.Color(
                            0.2 - t * 0.2,
                            0.1 + t * 0.4,
                            0.6 - t * 0.2
                        );
                    } else {
                        const t = (normalizedValue - 0.7) / 0.3;
                        return new THREE.Color(
                            0.0 + t * 0.2,
                            0.5 + t * 0.4,
                            0.4 - t * 0.2
                        );
                    }
                }

                return new THREE.Color(0.5, 0.5, 0.5);
            }

            dispose() {
                this.container.removeEventListener('mousemove', this.onMouseMove);
                window.removeEventListener('resize', this.handleResize);

                this.isAnimating = false;

                this.clearScene();

                if (this.renderer) {
                    this.renderer.dispose();
                    this.container.removeChild(this.renderer.domElement);
                }

                this.isInitialized = false;
            }
        }

        function initializeVisualization(songData, mode) {
            if (window.visualizer) {
                window.visualizer.dispose();
            }
            window.visualizer = new ModernPlaylistVisualizer('threeContainer');
            window.visualizer.loadSongs(songData, mode);

            document.getElementById('energyLegend').classList.add('hidden');
            document.getElementById('danceabilityLegend').classList.add('hidden');
            document.getElementById('moodLegend').classList.add('hidden');

            switch (mode) {
                case 'energy':
                    document.getElementById('energyLegend').classList.remove('hidden');
                    break;
                case 'danceability':
                    document.getElementById('danceabilityLegend').classList.remove('hidden');
                    break;
                case 'mood':
                    document.getElementById('moodLegend').classList.remove('hidden');
                    break;
            }
        }

        async function handleAnalyzeButtonClick() {
            const playlistUrl = elements.playlistUrlInput.value.trim();

            if (!playlistUrl) {
                alert('Please enter a Spotify playlist URL.');
                return;
            }

            state.isLoading = true;
            elements.analyzeBtn.disabled = true;
            elements.analyzeBtn.textContent = 'Processing...';
            elements.initialView.classList.add('hidden');
            elements.resultsContainer.classList.remove('hidden');
            elements.loadingAnalysis.classList.remove('hidden');
            elements.loadingVisualization.classList.remove('hidden');
            elements.analysisText.innerHTML = '';
            elements.playlistUrlDisplay.textContent = playlistUrl;

            try {
                let analysisData;
                
                if (playlistUrl === 'https://open.spotify.com/playlist/demo') {
                    analysisData = {
                        playlist_analysis: `This playlist offers a rich tapestry of emotions, weaving together a spectrum of sounds and experiences from various artists and genres. It begins with "Mirage" by Orion Sun, an ethereal introduction that invites listeners into a dream-like state, setting a tone of introspection. The transition to "Low Sun" by Hermanos Gutiérrez maintains a mellow atmosphere, with its instrumental depth creating a sense of calm and reflection. As we move into "ENAMEL" by Eddie Burns and William Corduroy, there is an introduction of electronic textures that subtly energizes the mood, hinting at complexity and modernity.

Amy Winehouse's "Valerie" in its live rendition injects a classic yet vibrant energy, bridging the playlist from introspective tones to the raw emotion of soulful nostalgia, which Mukesh's "KISI KI MUSKURAHATON PE" complements with its heartfelt warmth. This sets the stage for Lady Wray's "Guilty," which delves deeper into the raw and confessional, allowing the listener to explore themes of personal reckoning and authenticity. As the playlist progresses, songs like "What You Need" by KAYTRANADA and Charlotte Day Wilson, and "Shibuya" by Free Nationals and Syd, bring a smooth, contemporary groove that marries introspection with an upbeat energy, evolving the emotional arc toward liberation and connection.

A shift in tempo and mood occurs with Thundercat's "Dragonball Durag," injecting humor and lightheartedness, while Kokoroko's "Three Piece Suit" offers a fusion of jazz and Afrobeat, enriching the sonic landscape with layers of cultural and rhythmic heritage. The contemplative atmosphere is restored with Thee Sacred Souls' "Will I See You Again?" and KAMAUU's "MANGO," both exploring themes of longing and intimacy. Midway, Michael Kiwanuka's "Floating Parade" bridges the contemplative with a soulful and expansive sound, setting a reflective yet hopeful tone.

As the playlist transitions into tracks like "Where Are You?" by 54 Ultra and "Maria También" by Khruangbin, there is a thematic turn towards exploration and wanderlust, distinguished by instrumental storytelling and global influences. Erykah Badu's "Appletree" and Hiatus Kaiyote's "Red Room" delve into conscious introspection and narrative depth, expanding the thematic exploration to personal growth and resilience. Little Simz and Cleo Sol's "Woman" celebrates empowerment and identity with a confident and assertive energy.`,
                        songs: [
                            { title: "Mirage", artist: "Orion Sun", energy: 0.4, danceability: 0.3, mood: 0.6 },
                            { title: "Low Sun", artist: "Hermanos Gutiérrez", energy: 0.3, danceability: 0.2, mood: 0.7 },
                            { title: "ENAMEL", artist: "Eddie Burns & William Corduroy", energy: 0.6, danceability: 0.5, mood: 0.6 },
                            { title: "Valerie (Live)", artist: "Amy Winehouse", energy: 0.8, danceability: 0.7, mood: 0.8 },
                            { title: "KISI KI MUSKURAHATON PE", artist: "Mukesh", energy: 0.5, danceability: 0.4, mood: 0.9 },
                            { title: "Guilty", artist: "Lady Wray", energy: 0.7, danceability: 0.6, mood: 0.4 },
                            { title: "What You Need", artist: "KAYTRANADA ft. Charlotte Day Wilson", energy: 0.8, danceability: 0.9, mood: 0.7 },
                            { title: "Shibuya", artist: "Free Nationals & Syd", energy: 0.6, danceability: 0.8, mood: 0.8 },
                            { title: "Dragonball Durag", artist: "Thundercat", energy: 0.7, danceability: 0.8, mood: 0.9 },
                            { title: "Three Piece Suit", artist: "Kokoroko", energy: 0.8, danceability: 0.7, mood: 0.8 },
                            { title: "Will I See You Again?", artist: "Thee Sacred Souls", energy: 0.4, danceability: 0.5, mood: 0.6 },
                            { title: "MANGO", artist: "KAMAUU", energy: 0.5, danceability: 0.6, mood: 0.7 },
                            { title: "Floating Parade", artist: "Michael Kiwanuka", energy: 0.6, danceability: 0.4, mood: 0.8 },
                            { title: "Where Are You?", artist: "54 Ultra", energy: 0.4, danceability: 0.3, mood: 0.5 },
                            { title: "Maria También", artist: "Khruangbin", energy: 0.7, danceability: 0.6, mood: 0.7 },
                            { title: "Appletree", artist: "Erykah Badu", energy: 0.5, danceability: 0.7, mood: 0.8 },
                            { title: "Red Room", artist: "Hiatus Kaiyote", energy: 0.6, danceability: 0.5, mood: 0.7 },
                            { title: "Woman", artist: "Little Simz ft. Cleo Sol", energy: 0.9, danceability: 0.8, mood: 0.9 }
                        ],
                        track_count: 18
                    };
                } else {
                    analysisData = await fetchPlaylistAnalysis(playlistUrl);
                }

                displayAnalysisResults(analysisData);

                if (analysisData.songs && analysisData.songs.length > 0) {
                    state.playlistData = analysisData.songs;
                    initializeVisualization(analysisData.songs, state.visualizationMode);
                }

                state.isLoading = false;
                elements.analyzeBtn.disabled = false;
                elements.analyzeBtn.textContent = 'Analyze & Visualize';
                elements.loadingAnalysis.classList.add('hidden');
                elements.loadingVisualization.classList.add('hidden');
            } catch (error) {
                console.error('Error analyzing playlist:', error);
                elements.analysisText.innerHTML =
                    `<p class="text-red-500">Error: Could not analyze playlist. The playlist you provided is private or unavailable. Please make sure the playlist is public so it can be analyzed. You can change its visibility in the Spotify app by selecting 'Make Public' in the playlist settings.</br> ${error.message}</p>`;
                
                state.isLoading = false;
                elements.analyzeBtn.disabled = false;
                elements.analyzeBtn.textContent = 'Analyze & Visualize';
                elements.loadingAnalysis.classList.add('hidden');
                elements.loadingVisualization.classList.add('hidden');
            }
        }

        document.getElementById('energyLegend').classList.remove('hidden');
        document.getElementById('danceabilityLegend').classList.add('hidden');
        document.getElementById('moodLegend').classList.add('hidden');
        document.getElementById('dataSourceIndicator').classList.remove('hidden');

        const songTooltip = document.getElementById('songTooltip');
        if (songTooltip) {
            songTooltip.style.position = 'fixed';
            songTooltip.style.zIndex = '1000';
            songTooltip.classList.add('hidden');
            songTooltip.style.display = 'none';
        }

        elements.playlistUrlInput.value = 'https://open.spotify.com/playlist/demo';
    </script>
</body>

</html>